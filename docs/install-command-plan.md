# Plan: `tz install`

## Goal
Design the `tz install` command so that it reads the repository's `agents.toml`, resolves every declared package, and installs them into the local project workspace.

## Scope
- Single workspace repository invoking `tz install` from its root.
- `agents.toml` already exists (generated by `tz init` or hand-authored).
- Installs packages that are declaratively listed; no ad-hoc package arguments for this milestone.

Future work not covered in this plan includes monorepo workspaces, dependency graph visualisation, custom registries, or partial installs.

## User Journey
1. Developer runs `tz install` in a project containing `agents.toml`.
2. CLI validates configuration, resolves versions against the registry, and fetches package tarballs.
3. Packages are unpacked into `agent_modules/` with the correct directory structure.
4. Lockfile is created/updated to capture resolved versions and integrity hashes.
5. CLI prints a concise summary including newly installed packages and post-install actions (e.g., `tz apply`).

## High-Level Architecture
- **Command layer** (`src/commands/install.ts`):
  - Parse CLI flags (`--offline`, `--frozen-lockfile`, `--force`), read project context, call the package manager.
  - Surface structured progress to the logger.
- **Core package manager** (`src/core/package-manager.ts`):
  - Extend existing APIs or add a dedicated `installFromConfig` method that accepts CLI context.
  - Coordinate storage, registry client, lockfile, resolver, and integration hooks.
- **Config utilities** (`src/utils/config.ts`):
  - Add helper to read & validate `agents.toml`, returning normalized config + default registry scope.
- **Lockfile handling** (`src/core/lock-file.ts`):
  - Ensure new entries are written when packages are added or versions change.

## Detailed Work Items
1. **Configuration Loading**
   - Implement `loadProjectConfig(projectRoot)` that reads `agents.toml`, validates with existing zod schemas (extend if required), and returns the installable entries.
   - Error if file missing or malformed; suggest running `tz init`.

2. **Dependency Resolution**
   - Update resolver to accept the list of requested packages with optional version ranges.
   - Use SAT solver/resolver to produce a resolved manifest (package name â†’ version + integrity).
   - Respect lockfile data when `--frozen-lockfile` is supplied (fail on drift).

3. **Download & Extraction**
   - For each resolved package, check local cache (`storage` layer). Fetch from registry when absent or `--force` is set.
   - Verify tarball integrity via hash.
   - Extract into `agent_modules/<scope>/<name>/<version>/` with immutable permissions.

4. **Lockfile Update**
   - Merge resolved graph into `agents.lock`. Write deterministically (sorted keys, newline conventions).
   - Include metadata: registry URL, tarball integrity, install timestamp.

5. **Integrations Hook**
   - After install, trigger `apply` integration if `agents.toml` has exports.
   - Provide `--no-apply` flag to skip (mirroring `tz add`).

6. **Logging & UX**
   - Structured logger events: `config:loaded`, `resolve:start/end`, `download:skip/use-cache`, `extract:done`, `lockfile:written`.
   - Final summary table with package, version, source (cache/remote).

7. **Tests**
   - Unit tests for `loadProjectConfig`, resolver integration, storage fetch toggles.
   - Integration test covering end-to-end install using dummy registry (existing test harness).
   - Scenario tests: missing `agents.toml`, cache hits, frozen lockfile mismatch, apply hook triggered.

8. **Documentation**
   - Update CLI help (`src/index.ts` command registration, `README.md`, and docs) explaining new command & flags.

## Risks & Mitigations
- **Malformed configurations**: enforce strict zod validation and descriptive error codes.
- **Network flakiness**: leverage existing retry/backoff in registry client; fallback to cache when offline.
- **Lockfile conflicts**: design deterministic merge; provide `--force` to regenerate.
- **Parallel downloads**: reuse existing concurrency controls to avoid saturating registry.

## Success Criteria
- `tz install` installs all packages declared in `agents.toml` into `agent_modules/` and updates the lockfile.
- Re-running without changes results in no-op with clear messaging.
- Frozen lockfile mismatches fail fast without altering filesystem state.
- Tests cover main flows and edge cases; documentation explains usage and flags.
